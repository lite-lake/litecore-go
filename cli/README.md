# CLI

CLI 是 LiteCore 框架的代码生成工具，用于自动生成 5 层依赖注入架构的容器初始化代码。

## 特性

- **自动扫描**：自动扫描项目中的 Entity、Repository、Service、Controller、Middleware 组件
- **分层生成**：按 LiteCore 分层架构生成各层容器初始化代码
- **依赖注入**：自动注册组件到依赖注入容器，支持 `inject:""` 标签
- **灵活配置**：支持自定义项目路径、输出目录、包名和配置文件路径

## 快速开始

### 方式一：作为独立命令行工具

```bash
# 构建工具
go build -o litecore-generate ./cli

# 使用默认配置生成
./litecore-generate

# 使用自定义参数
./litecore-generate -project . -output internal/application -package application -config configs/config.yaml
```

### 方式二：作为库导入使用

在业务项目中创建自定义生成器入口：

```go
package main

import (
	"flag"
	"fmt"
	"os"

	"github.com/lite-lake/litecore-go/cli/generator"
)

func main() {
	cfg := generator.DefaultConfig()

	// 支持命令行参数覆盖
	outputDir := flag.String("o", cfg.OutputDir, "输出目录")
	packageName := flag.String("pkg", cfg.PackageName, "包名")
	configPath := flag.String("c", cfg.ConfigPath, "配置文件路径")
	flag.Parse()

	if outputDir != nil {
		cfg.OutputDir = *outputDir
	}
	if packageName != nil {
		cfg.PackageName = *packageName
	}
	if configPath != nil {
		cfg.ConfigPath = *configPath
	}

	if err := generator.Run(cfg); err != nil {
		fmt.Fprintf(os.Stderr, "错误: %v\n", err)
		os.Exit(1)
	}
}
```

参考示例：`samples/messageboard/cmd/generate/main.go`

## 生成的文件

```
internal/application/
├── entity_container.go      # 实体容器初始化
├── repository_container.go  # 仓储容器初始化
├── service_container.go     # 服务容器初始化
├── controller_container.go   # 控制器容器初始化
├── middleware_container.go   # 中间件容器初始化
└── engine.go                # 引擎创建函数
```

## 代码约定

### 目录结构

```
项目根目录/
├── internal/
│   ├── entities/        # 实体层：导出的结构体类型
│   ├── repositories/     # 仓储层：I 前缀接口 + New 前缀工厂函数
│   ├── services/         # 服务层：I 前缀接口 + New 前缀工厂函数
│   ├── controllers/      # 控制器层：I 前缀接口 + New 前缀工厂函数
│   └── middlewares/      # 中间件层：I 前缀接口 + New 前缀工厂函数
```

### 命名规范

| 层级 | 接口命名 | 工厂函数命名 |
|------|----------|--------------|
| Entity | `MessageEntity` | 无需工厂函数 |
| Repository | `IMessageRepository` | `NewMessageRepository()` |
| Service | `IMessageService` | `NewMessageService()` |
| Controller | `IMessageController` | `NewMessageController()` |
| Middleware | `IAuthMiddleware` | `NewAuthMiddleware()` |

## 使用生成的代码

```go
package main

import (
	"log"

	app "github.com/example/project/internal/application"
)

func main() {
	engine, err := app.NewEngine()
	if err != nil {
		log.Fatalf("Failed to create engine: %v", err)
	}

	if err := engine.Initialize(); err != nil {
		log.Fatalf("Failed to initialize engine: %v", err)
	}

	if err := engine.Start(); err != nil {
		log.Fatalf("Failed to start engine: %v", err)
	}

	engine.WaitForShutdown()
}
```

## API

### generator.Config

生成器配置结构体：

```go
type Config struct {
	ProjectPath string // 项目路径
	OutputDir   string // 输出目录
	PackageName string // 包名
	ConfigPath  string // 配置文件路径
}
```

### generator.Run

运行代码生成器：

```go
func Run(cfg *Config) error
```

### generator.MustRun

运行代码生成器，失败时 panic：

```go
func MustRun(cfg *Config)
```

### generator.DefaultConfig

返回默认配置：

```go
func DefaultConfig() *Config
```

默认值：
- ProjectPath: `.`
- OutputDir: `internal/application`
- PackageName: `application`
- ConfigPath: `configs/config.yaml`

## 依赖注入

生成的容器自动识别并注入 `inject:""` 标签的依赖：

```go
type MessageService struct {
	Config    configmgr.IConfigManager    `inject:""`
	DBManager databasemgr.IDatabaseManager `inject:""`
	LoggerMgr loggermgr.ILoggerManager    `inject:""`
	Repo      repositories.IMessageRepository `inject:""`
}
```

## 命令行参数

| 参数 | 简写 | 默认值 | 说明 |
|------|------|--------|------|
| `-project` | `-p` | `.` | 项目路径 |
| `-output` | `-o` | `internal/application` | 输出目录 |
| `-package` | `-pkg` | `application` | 包名 |
| `-config` | `-c` | `configs/config.yaml` | 配置文件路径 |
| `-version` | `-v` | - | 显示版本信息 |

## 注意事项

1. 生成的代码头部包含 `// Code generated by litecore/cli. DO NOT EDIT.` 注释，不应手动修改
2. 组件接口必须使用 `I` 前缀（如 `IMessageService`）
3. 工厂函数必须使用 `New` 前缀（如 `NewMessageService`）
4. 配置文件必须存在且格式正确
